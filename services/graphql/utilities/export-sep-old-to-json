require("dotenv").config({
  path: "../../../.env",
});

const dayjs = require("dayjs");
const { v4: uuidv4 } = require("uuid");
const sql = require("mssql");
const fs = require("fs");
const path = require("path");
const JSONStream = require("JSONStream");

const start = async () => {
  const sqlConfig = {
    user: "app_sep",
    password: "LD2022",
    database: "SEPBAK",
    server: "192.168.1.77\\mcbcloud",
    options: {
      encrypt: false,
      trustServerCertificate: true,
      // enableArithAbort: true,
      // trustConnection: true
    },
  };
  console.log({ sqlConfig });

  const backupFolderPath = path.join(
    require("os").homedir(),
    "Desktop",
    "backupJSON",
  );

  try {
    // Create backup folder if it doesn't exist
    if (!fs.existsSync(backupFolderPath)) {
      fs.mkdirSync(backupFolderPath);
    }
    // Create a pool of connections
    const pool = await sql.connect(sqlConfig);
    const result = await pool
      .request()
      .query(
        `SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE'`,
      );

    // Iterate through each table name
    for (const table of result.recordset) {
      // Query to retrieve all rows from the table
      // const { recordset } = await pool
      //   .request()
      //   .query(`SELECT * FROM ${table.TABLE_NAME}`);

      // // Save the table data as a JSON file
      // const filename = `${table.TABLE_NAME}.json`;
      // const data = JSON.stringify(recordset);

      // fs.writeFile(path.join(backupFolderPath, filename), data, err => {
      //   if (err) throw err;
      //   console.log(`Saved ${table.TABLE_NAME} data to ${filename}`);
      // });

      if (
        table.TABLE_NAME !== "tblIntMonthlyAveragesICCO" ||
        table.TABLE_NAME !== "tbIntCocoaInternationalSignificance"
      ) {
        continue;
      }
      console.log("Processing table", table.TABLE_NAME);

      //#################################################//
      const filename = `${table.TABLE_NAME}.json`;
      const writeStream = fs.createWriteStream(
        path.join(backupFolderPath, filename),
      );

      // Create a read stream for the MSSQL query and pipe it to the write stream
      const query = `SELECT * FROM ${table.TABLE_NAME}`;
      const readStream = pool
        .request()
        .query(query)
        .pipe(JSONStream.stringify());

      // Write the data to the JSON file
      await new Promise((resolve, reject) => {
        writeStream.on("finish", resolve);
        writeStream.on("error", reject);
        readStream.on("error", reject);
        readStream.pipe(writeStream);
      });

      console.log(`Saved ${table.TABLE_NAME} data to ${filename}`);
    }

    pool.close();
  } catch (err) {
    console.error(err);
  }
};

start();

function sleep(ms) {
  return new Promise(resolve => {
    setTimeout(resolve, ms);
  });
}
